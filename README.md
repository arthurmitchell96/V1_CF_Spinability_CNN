# V1_CF_Spinability_CNN
A script to investigate if it is possible to classify differences between CF spinability measuremnets with and without drug application, in his case cultures witht he R347P mutation with and without VX-445, VX-661, and VX-770. The data is not currently included in this scipt as we have not published it yet, hence this script is here to give an idea of a project I have worked on. The scipt is also V1 proof of concept script, we had no idea if this would actually work when trying. I use Keras and tensorflow to create this model.

**The Data**
The data is based on mucus snap lengths generated by scanning ion condutance microscopy (SICM), a full sumamry of the data collection method can be found in Ivanova, R., Benton, D.C., Munye, M.M., Rangseesorranan, S., Hart, S.L. and Moss, G.W., 2019. A nanosensor toolbox for rapid, label-free measurement of airway surface liquid and epithelial cell function. ACS applied materials & interfaces, 11(9), pp.8731-8739.
A short summary is that a micro-pipette is dipped in the mucus layer of a human bronchial epithelium culture and withdrawn at 1 um/s resulting in a 'thread' of mucus being stretched. As the thread gets longer the current drops until the thread snaps and the current drops to 0. By taking the start and end points it is possible to obtain the 'mucus snap length' giving a quantative measure of spinability for airway mucus. The data was collected in an enviorment chamber, heated to 37C, 5% C02 and 99% humidity. The result of this produces as trace like this one (pleae excuse the labels I hastily made in paint):
![Quick spinability snaplength](https://github.com/arthurmitchell96/V1_CF_Spinability_CNN/assets/18124443/034c34f3-27c6-49ea-8157-70a7a159d603)

This makes it easy to claculate the snap length but what about the curve shape? We are interested if the shape of the curve changes along with the snap length and can you classify drug application or mutation type only from the curve?

There are several  datapoints to consider when building this classifier; Trace airway surface liquid depth depth, Pipette resistance, was the culture infected, transepithelial potential difference (TEPD),  and the 90% current reduction point. A description of this data is as follows:
-  Current trace: the recors of the change in current while the pipette is withdrawn
-  ASL depth: with each spinability measuremnt there is a corresponing ASL dpeth, theoretically this corresponds to more hydrated mucus, and ASL depth is depleted in CF. Measured in microns and a more thorough summary is given in Ivanova et al. (2019).
- Pipette resistance: The size of the pipette used is around 100 nm in diameter but it is difficult to tell, howver, it is possible to measure the resistance of the pipette giving an approximation of the size of the pipette. I am unsure if this will have ny effect on the snap lengths. Measured in MOhms, not used in this example.
- Infetion: the cultures are very prone to infection as the SICM is not a sterile enviorment. Infection will change the mucins and interlukins realsed by the cells, changing the properties of the mucus. This is encoded as 0: not infected, 1: Poiible infection or day before confirmed infection, 2: Infected/dead
- TEPD: the TEPD is the potential across the cells, epithelial cells also have transepithelial transport. Drug addition, changing the function of ion channels will effect TEPD, as will infections. Measured in mV, not used in this example
- The 90% current reduction point and snap length: As part of this model I ended up standardising the x-axis (explained in the next section) so these datapoints provide descriptions of how long the snap length is and how fast the current declines  

**Preprocessing the trace**
There are several issues with the trace, the first problem is that it is saved as an ABF file, this is a rare file type requiring sevral conversions to a file type appropriate for Keras to process. 

The second problem is the sample rate, the SICM samples at 20 KHz, so even short recording produce large, noisy, recodings. There is also a third problem as ther recodings are of different lengths depending on the snap length, varying form 3 seconds to 30 minuets. This makes the input of the CNN very challenging as even with a fully convelutional first layer would use alot of memory (to compensate for the high sample rate). To solve both issues theI deided to standardise the the x axis to the length of the shortest array. Zero padding to the largest array length was tried, howver my laptop did not have the required computational power to do this. Recodings were downsampled for more effienct computation time and noise reduction. I use a median filter to do this changinging the filter size to allow all arrays to be reduced to the same length. An improvement could be to scale all of the recodings to a specified array size so that the time data is preserved. It does mean that longer arrays will loose more data, but they should be ableto keep the sahpe of the trace. As I have essentially removed the time data from the traces the 90% snap point and snap length are added in as extra inputs. The was done in an attempt to keep the shape the curves while scrifincing the time data.

There is also an issue with data avaliblilty, with only 400 samples the may not be enough for any meaningful classifcation. ANother issue is that the current (y axis) will vary having no effect on the snap length, to solve the y axis was normalised between 0 and 1.

The final problem is the resulting arrays are still large now all being of length 36320 meaning large kerenel sizes will be needed to large. I could filter or reduce the arrays some more but I did not want to lose any more data. The large kerneal sizes reduce the size of the model that can be used. 

**The model**
As I am using both numerical, catagorical and time series data I decided a multi headed approcah was needed. As we were primarly focused on the shape of the trace I used a 1D CNN to analyse it. The other data was fed into a dense neural network. Adam optimiser was used with binary crossentropy. A diagram can be found below.


![Model diagram](https://github.com/arthurmitchell96/V1_CF_Spinability_CNN/assets/18124443/33dcfdfa-908a-4833-8c02-bbec24b2abeb)

**Results**
Unfrotunately the result was not great, 65% train accuracy and 60% validation. However, there is much to improve in the model. The preprocessing steps leave much to be desired and are likely reducing the classifcation accuracy. It is also possible there is too little data to use this method. However, not all of the data was used such as pipette resistance and TEPD. It is also possible that a 1D CNN os no the best classifer to use. Perhaps a recurrent network or other non-deep learning methods such as NN-clustering would work better for this purpose. As a proof of concept this prvides some evidence that calssifcation based on curve shape is possible, even though it is only above nothing by 15%.
